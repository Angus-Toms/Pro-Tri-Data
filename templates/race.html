{% extends "base.html" %}

{% block title %}{{ race.race_title }} - {{ race.date.strftime('%B %d %Y') }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ STATIC_BASE_URL }}css/race.css">
{% endblock %}

{% block content %}
<div class="race-hero">
    <div class="race-hero-main">
        <!-- Race Information -->
        <div class="race-hero-info">
            <h1>{{ race.race_title }}</h1>
            
            <div class="meta-grid">
                <div class="meta-item">
                    <span class="meta-label">Date</span>
                    <span class="meta-value">{{ race.date.strftime('%B %d, %Y') }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Location</span>
                    <span class="meta-value">{{ race_location }}, {{ race_country }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Program</span>
                    <span class="meta-value">{{ race.prog_name }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Race ID</span>
                    <span class="meta-value">{{ race.race_id }}</span>
                </div>
            </div>

            <!-- Key stats -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number">{{ race.athlete_count }}</div>
                    <div class="stat-label">Athletes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ finish_count }}</div>
                    <div class="stat-label">Finishers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ dnf_count }}</div>
                    <div class="stat-label">DNFs</div>
                </div>
            </div>
        </div>

        <!-- Podium -->
        <div class="race-podium-section">
            {% if splits_data and splits_data|length > 0 %}
            <div class="podium-header">Podium</div>
            <div class="podium-list">
                {% for athlete in splits_data[:3] %}
                    {% if athlete.position in ['1', '2', '3'] %}
                    <div class="podium-item {{ 'gold' if athlete.position == '1' else 'silver' if athlete.position == '2' else 'bronze' }}">
                        <div class="podium-position">{{ athlete.position }}</div>
                        <img
                        src="{{ STATIC_BASE_URL ~ 'athlete_imgs/128/' ~ athlete.athlete_id ~ '.webp' }}"
                        data-fallback="{{ url_for('static', path='imgs/default_user.jpg') }}"
                        onerror="this.onerror=null;this.src=this.dataset.fallback;"
                        alt="{{ athlete.name }}"
                        class="podium-avatar"
                        />
                        <div class="podium-details">
                            <div class="podium-name">
                                <a href="/athlete/{{ athlete.athlete_id }}">{{ athlete.name }}</a>
                                <span class="podium-country">{{ athlete.country_emoji }}</span>
                            </div>
                            <div class="podium-time">
                                {{ athlete.overall_}}
                                {% if athlete.overall_behind_s != "+00:00" %}
                                    ({{ athlete.overall_behind_s }})
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Race standards and Best Performances -->
<div class="ratings-overview">
    <div class="ratings-section">
        <h3 class="card-title">Race Standards</h3>
        <div class="ratings-grid">
            <div class="rating-box">
                <div class="rating-discipline">Overall</div>
                <div class="rating-number">{{ race_standards.overall }}</div>
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Swim</div>
                <div class="rating-number">{{ race_standards.swim }}</div>
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Bike</div>
                <div class="rating-number">{{ race_standards.bike }}</div>
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Run</div>
                <div class="rating-number">{{ race_standards.run }}</div>
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Transition</div>
                <div class="rating-number">{{ race_standards.transition }}</div>
            </div>
        </div>
    </div>


    <div class="ratings-section">
        <h3 class="card-title">Best Performances</h3>
        <div class="ratings-grid">
            <div class="rating-box">
                <div class="rating-discipline">Overall</div>
                <div class="rating-number {{ best_performances.overall_change.css_class }}">{{ best_performances.overall_change.formatted_str }}</div>
                {% if best_performances.overall_athlete_name %}    
                    <div class="rating-race">
                        <a href="/athlete/{{ race.overall_increase_athlete_id }}" class="small-link">
                            {{ best_performances.overall_athlete_name }}
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Swim</div>
                <div class="rating-number {{ best_performances.swim_change.css_class }}">{{ best_performances.swim_change.formatted_str }}</div>
                {% if best_performances.swim_athlete_name %}
                    <div class="rating-race">
                        <a href="/athlete/{{ race.swim_increase_athlete_id }}" class="small-link">
                            {{ best_performances.swim_athlete_name }}
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Bike</div>
                <div class="rating-number {{ best_performances.bike_change.css_class }}">{{ best_performances.bike_change.formatted_str }}</div>
                {% if best_performances.bike_athlete_name %}
                    <div class="rating-race">
                        <a href="/athlete/{{ race.bike_increase_athlete_id }}" class="small-link">
                            {{ best_performances.bike_athlete_name }}
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Run</div>
                <div class="rating-number {{ best_performances.run_change.css_class }}">{{ best_performances.run_change.formatted_str }}</div>
                {% if best_performances.run_athlete_name %}
                    <div class="rating-race">
                        <a href="/athlete/{{ race.run_increase_athlete_id }}" class="small-link">
                            {{ best_performances.run_athlete_name }}
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="rating-box">
                <div class="rating-discipline">Transition</div>
                <div class="rating-number {{ best_performances.transition_change.css_class }}">{{ best_performances.transition_change.formatted_str }}</div>
                {% if best_performances.transition_athlete_name %}
                    <div class="rating-race">
                        <a href="/athlete/{{ race.transition_increase_athlete_id }}" class="small-link">
                            {{ best_performances.transition_athlete_name }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="data-table collapsible-card">
    <h3 class="card-title">
        Race Results
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">
        <table class="sortable-table results-table">
            <thead>
                <tr>
                    <th class="sortable position-col" data-sort="position">Position</th>
                    <th class="sortable athlete-col" data-sort="string">Athlete</th>
                    <th class="sortable yob-col" data-sort="number">YOB</th>
                    <th class="sortable time-col" data-sort="time">Overall</th>
                    <th class="sortable time-col" data-sort="time">Swim</th>
                    <th class="sortable time-col" data-sort="time">T1</th>
                    <th class="sortable time-col" data-sort="time">Bike</th>
                    <th class="sortable time-col" data-sort="time">T2</th>
                    <th class="sortable time-col" data-sort="time">Run</th>
                </tr>
            </thead>
            <tbody>
                {% if splits_data %}
                    {% for athlete in splits_data %}
                    <tr>
                        <td class="position-col position-cell {{'position-gold' if athlete.position == '1' else 'position-silver' if athlete.position == '2' else 'position-bronze' if athlete.position == '3' else 'position-dnf' if athlete.position in ['DNF', 'DQ', 'LAP'] else ''}}" data-value="{{ athlete.position }}">
                            {{ athlete.position }}
                        </td>
                        <td class="athlete-col" data-value="{{ athlete.name }}">
                            <a href="/athlete/{{ athlete.athlete_id }}" class="link">
                                {{ athlete.name }} {{ athlete.country_emoji }}
                            </a>
                        </td>
                        <td class="yob-col" data-value="{{ athlete.year_of_birth if athlete.year_of_birth else 0 }}">
                            {{"{} ({})".format(athlete.year_of_birth, athlete.age) if athlete.year_of_birth else "" }}
                        </td>
                        <td class="time-col overall-time" data-value="{{ athlete.overall_s }}">
                            <div class="time-cell">
                                {{ athlete.overall_s }}
                                <span class="time-behind">
                                    {{ athlete.overall_behind_s }}
                                </span>
                            </div>
                        </td>
                        <td class="time-col" data-value="{{ athlete.swim_s }}">
                            <div class="time-cell">
                                {{ athlete.swim_s }}
                                <span class="time-behind">
                                    {{ athlete.swim_behind_s }}
                                </span>
                            </div>
                        </td>
                        <td class="time-col" data-value="{{ athlete.t1_s }}">
                            <div class="time-cell">
                                {{ athlete.t1_s }}
                                <span class="time-behind">
                                    {{ athlete.t1_behind_s }}
                                </span>
                            </div>
                        </td>
                        <td class="time-col" data-value="{{ athlete.bike_s }}">
                            <div class="time-cell">
                                {{ athlete.bike_s }}
                                <span class="time-behind">
                                    {{ athlete.bike_behind_s }}
                                </span>
                            </div>
                        </td>
                        <td class="time-col" data-value="{{ athlete.t2_s }}">
                            <div class="time-cell">
                                {{ athlete.t2_s }}
                                <span class="time-behind">
                                    {{ athlete.t2_behind_s }}
                                </span>
                            </div>
                        </td>
                        <td class="time-col" data-value="{{ athlete.run_s }}">
                            <div class="time-cell">
                                {{ athlete.run_s }}
                                <span class="time-behind">
                                    {{ athlete.run_behind_s}}
                                </span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="no-data">No data available</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Ratings Table -->
<div class="data-table collapsible-card">
    <h3 class="card-title">
        Ratings & Changes
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">
        <table class="data-table sortable-table rating-table">
            <thead>
                <tr>
                    <th class="sortable position-col" data-sort="position">Position</th>
                    <th class="sortable athlete-col" data-sort="string">Athlete</th>
                    <th class="sortable yob-col" data-sort="number">YOB</th>
                    <th class="sortable rating-col" data-sort="rating">Overall</th>
                    <th class="sortable rating-col" data-sort="rating">Swim</th>
                    <th class="sortable rating-col" data-sort="rating">Bike</th>
                    <th class="sortable rating-col" data-sort="rating">Run</th>
                    <th class="sortable rating-col" data-sort="rating">Transition</th>
                </tr>
            </thead>
            <tbody>
                {% if ratings_data %}
                    {% for athlete in ratings_data %}
                    <tr>
                        <td class="position-cell {{'position-gold' if athlete.position == '1' else 'position-silver' if athlete.position == '2' else 'position-bronze' if athlete.position == '3' else 'position-dnf' if athlete.position in ['DNF', 'DQ', 'LAP'] else ''}}" data-value="{{ athlete.position }}">
                            {{ athlete.position }}
                        </td>
                        <td data-value="{{ athlete.name }}">
                            <a href="/athlete/{{ athlete.athlete_id }}" class="link">
                                {{ "{} {}".format(athlete.name, athlete.country_emoji) }}
                            </a>
                        </td>
                        <td data-value="{{ athlete.year_of_birth }}">
                            {{ "{} ({})".format(athlete.year_of_birth, athlete.age) if athlete.year_of_birth else "" }}
                        </td>
                        <td data-value="{{ athlete.overall_rating }}">
                            <div class="rating-cell">
                                {{ athlete.overall_rating }}
                                <span class="rating-change {{ athlete.overall_change.css_class }}">
                                    {{ athlete.overall_change.formatted_str }}
                                </span>
                            </div>
                        </td>
                        <td data-value="{{ athlete.swim_rating }}">
                            <div class="rating-cell">
                               {{ athlete.swim_rating }}
                                <span class="rating-change {{ athlete.swim_change.css_class }}">
                                    {{ athlete.swim_change.formatted_str }}
                                </span>
                            </div>
                        </td>
                        <td data-value="{{ athlete.bike_rating }}">
                            <div class="rating-cell">
                                {{ athlete.bike_rating }}
                                <span class="rating-change {{ athlete.bike_change.css_class }}">
                                    {{ athlete.bike_change.formatted_str }}
                                </span>
                            </div>
                        </td>
                        <td data-value="{{ athlete.run_rating }}">
                            <div class="rating-cell">
                                {{ athlete.run_rating }}
                                <span class="rating-change {{ athlete.run_change.css_class }}">
                                    {{ athlete.run_change.formatted_str }}
                                </span>
                            </div>
                        </td>
                        <td data-value="{{ athlete.transition_rating }}">
                            <div class="rating-cell">
                                {{ athlete.transition_rating }}
                                <span class="rating-change {{ athlete.transition_change.css_class }}">
                                    {{ athlete.transition_change.formatted_str }}
                                </span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="no-data">No data available</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Time Distribution Histograms -->
<div class="collapsible-card">
    <h3 class="card-title">
        Time Distributions
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">
        <div class="charts-grid">
            <div class="mini-chart">
                <h4>Overall Times</h4>
                <div class="chart-container-compact">
                    <canvas id="overall-times-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Swim Times</h4>
                <div class="chart-container-compact">
                    <canvas id="swim-times-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Bike Times</h4>
                <div class="chart-container-compact">
                    <canvas id="bike-times-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Run Times</h4>
                <div class="chart-container-compact">
                    <canvas id="run-times-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>T1 Times</h4>
                <div class="chart-container-compact">
                    <canvas id="t1-times-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>T2 Times</h4>
                <div class="chart-container-compact">
                    <canvas id="t2-times-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rating distribution histograms -->
<div class="collapsible-card">
    <h3 class="card-title">
        Rating Distributions
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">
        <div class="charts-grid">
            <div class="mini-chart full-width">
                <h4>Overall Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="overall-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Swim Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="swim-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Bike Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="bike-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Run Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="run-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Transition Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="transition-ratings-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Time histograms -->
<script id="overall-time-hist-data" type="application/json">
    {{ overall_time_hist | tojson }}
</script>
<script id="swim-time-hist-data" type="application/json">
    {{ swim_time_hist | tojson }}
</script>
<script id="bike-time-hist-data" type="application/json">
    {{ bike_time_hist | tojson }}
</script>
<script id="run-time-hist-data" type="application/json">
    {{ run_time_hist | tojson }}
</script>
<script id="t1-time-hist-data" type="application/json">
    {{ t1_time_hist | tojson }}
</script>
<script id="t2-time-hist-data" type="application/json">
    {{ t2_time_hist | tojson }}
</script>

<!-- Rating histograms -->
<script id="overall-ratings-hist-data" type="application/json">
    {{ overall_rating_hist | tojson }}
</script>
<script id="swim-ratings-hist-data" type="application/json">
    {{ swim_rating_hist | tojson }}
</script>
<script id="bike-ratings-hist-data" type="application/json">
    {{ bike_rating_hist | tojson }}
</script>
<script id="run-ratings-hist-data" type="application/json">
    {{ run_rating_hist | tojson }}
</script>
<script id="transition-ratings-hist-data" type="application/json">
    {{ transition_rating_hist | tojson }}
</script>

<script src="{{ STATIC_BASE_URL }}js/utils.js"></script>
<script src="{{ STATIC_BASE_URL }}js/race.js"></script>
{% endblock %}
