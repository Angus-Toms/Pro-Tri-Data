<!-- Ratings comparison -->
<div class="collapsible-card">
    <h3 class="card-title">
        Current Ratings
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">

        {% for discipline in head_to_head_ratings %}
        <div class="h2h-row">
            <!-- Left rating -->
            <div class="rating-block left {% if discipline.rating1 > discipline.rating2 %}winner{% endif %}">
                <div class="rating-number">{{ discipline.rating1 }}</div>
                <div class="rating-change {{ discipline.change1.css_class }}">
                    {{ discipline.change1.formatted_str }}
                </div>
            </div>
            <!-- Discipline in middle -->
            <div class="h2h-discipline">
                {{ discipline.label }}
            </div>
            <!-- Right rating -->
            <div class="rating-block right {% if discipline.rating2 > discipline.rating1 %}winner{% endif %}">
                <div class="rating-number">{{ discipline.rating2 }}</div>
                <div class="rating-change {{ discipline.change2.css_class }}">
                    {{ discipline.change2.formatted_str }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Key race stats comparison -->
<div class="collapsible-card">
    <h3 class="card-title">
        Career Statistics
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">
        <div>
            {% for stat in [
                ('Total Races', athlete1.stats.total_races, athlete2.stats.total_races),
                ('Wins', athlete1.stats.wins, athlete2.stats.wins),
                ('Podiums', athlete1.stats.podiums, athlete2.stats.podiums)
            ] %}
            <div class="h2h-row">
                <div class="rating-block {{ 'winner' if stat[1] > stat[2] else '' }}">
                    <div class="rating-number">{{ stat[1] }}</div>
                </div>
                <div class="h2h-discipline">{{ stat[0] }}</div>
                <div class="rating-block rating-number {{ 'winner' if stat[2] > stat[1] else '' }} right">
                    <div class="rating-number">{{ stat[2] }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Full race results comparison -->
{% if head_to_head %}
<div class="collapsible-card">
    <h3 class="card-title">
        Head-to-Head Record
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">
        
        <!-- H2H race win counts -->
        <table class="h2h-wins">
            <colgroup>
                <col>
                <col class="h2h-wins-center">
                <col>
            </colgroup>
            <tbody>
                <tr>
                    <td class="h2h-win-count">{{ athlete1.stats.h2h_wins }}</td>
                    <td class="h2h-win-count">{{ head_to_head|length }}</td>
                    <td class="h2h-win-count">{{ athlete2.stats.h2h_wins }}</td>
                </tr>
                <tr>
                    <td class="h2h-win-label">{{ athlete1.name }} wins</td>
                    <td class="h2h-win-label">Total Races</td>
                    <td class="h2h-win-label">{{ athlete2.name }} wins</td>
                </tr>
            </tbody>
        </table>

        <!-- Full H2h results -->
        <table class="h2h-table">
            <thead>
                <tr>
                    <th class="date-col" rowspan="2">Date</th>
                    <th class="race-col" rowspan="2">Race</th>

                    <!-- Athlete columns span both position and time -->
                    <th class="athlete-name-th" colspan="2">{{ athlete1.name }}</th>
                    <th class="athlete-name-th" colspan="2">{{ athlete2.name }}</th>
                </tr>

                <tr>
                    <th class="position-col">Position</th>
                    <th>
                        <div>Time</div>
                        <div class="time-behind-header">(Time Behind)</div>
                    </th>

                    <th class="position-col">Position</th>
                    <th>
                        <div>Time</div>
                        <div class="time-behind-header">(Time Behind)</div>
                    </th>
                </tr>
            </thead>

            <tbody>
                {% for race in head_to_head %}
                <tr>
                    <td>{{ race.race_date.strftime('%-d %b %Y') }}</td>
                    <td>
                        <a href="/race/{{ race.race_id }}" class="link">
                            {{ race.race_name }}
                        </a>
                    </td>

                    <!-- Athlete 1 position, time, and time behind -->
                    <td class="position-col position-cell {{ 'position-gold' if race.athlete1_position == '1' else 'position-silver' if race.athlete1_position == '2' else 'position-bronze' if race.athlete1_position == '3' else 'position-dnf' if race.athlete1_position in ['DNF', 'DNS', 'DQ', 'LAP', 'NC'] else '' }}">
                        {{ race.athlete1_position }}
                    </td>

                    <td class="{{ race.athlete1_time.css_class }}">
                        <div class="time-cell">
                            {{ race.athlete1_time.formatted_str }}
                            <span class="time-behind">
                                {{ race.athlete1_behind }}
                            </span>
                        </div>
                    </td>

                    <!-- Athlete 2 position, time, and time behind -->
                    <td class="position-cell {{ 'position-gold' if race.athlete2_position == '1' else 'position-silver' if race.athlete2_position == '2' else 'position-bronze' if race.athlete2_position == '3' else 'position-dnf' if race.athlete2_position in ['DNF', 'DNS', 'DQ', 'LAP', 'NC'] else '' }}">
                        {{ race.athlete2_position }}
                    </td>
                    <td class="{{ race.athlete2_time.css_class }}">
                        <div class="time-cell">
                            {{ race.athlete2_time.formatted_str }}
                            <span class="time-behind">
                                {{ race.athlete2_behind }}
                            </span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<!-- No common race results found -->
<div>
    <p style="text-align: center; color: var(--text-light);">No head-to-head races found</p>
</div>
{% endif %}

<!-- Historical Ratings Comparisons -->
<div class="collapsible-card">
    <h3 class="card-title">
        Ratings Comparison
        <span class="collapse-toggle" onclick="toggleCollapse(this)">−</span>
    </h3>
    <div class="collapsible-content">

    <!-- Alignment button -->
    <button 
        id="align-btn" 
        class="align-starts-button"
        onclick="alignChartStarts()"
    >
        Align Career Starts
    </button>
    <p class="align-button-hint">Compare careers from Day 0 regardless of actual dates</p>

        <div class="charts-grid">
            <div class="mini-chart full-width">
                <h4>Overall Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="overall-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Swim Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="swim-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Bike Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="bike-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Run Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="run-ratings-canvas"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <h4>Transition Ratings</h4>
                <div class="chart-container-compact">
                    <canvas id="transition-ratings-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% block comparison_specific_js %}
<!-- Rating comparison charts -->
<script id="overall-ratings-data" type="application/json">
    {{ overall_ratings_chart | tojson }}
</script>
<script id="swim-ratings-data" type="application/json">
    {{ swim_ratings_chart | tojson }}
</script>
<script id="bike-ratings-data" type="application/json">
    {{ bike_ratings_chart | tojson }}
</script>
<script id="run-ratings-data" type="application/json">
    {{ run_ratings_chart | tojson }}
</script>
<script id="transition-ratings-data" type="application/json">
    {{ transition_ratings_chart | tojson }}
</script>
{% endblock %}
