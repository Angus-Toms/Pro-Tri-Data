{% extends "base.html" %}

{% block title %}Leaderboard - Pro Tri Data{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://static.protridata.com/css/leaderboard.css">
{% endblock %}

{% block content %}
<div class="leaderboard-header">
    <h1>Athlete Leaderboard</h1>
    <p>Compare athlete performance across different disciplines</p>
</div>

<div class="filters-card">
    <form method="get" action="/leaderboard" class="filters-form">
        
        <!-- Gender filter -->
        <div class="filter-section">
            <h3>Gender</h3>
            <div class="radio-buttons">
                <input type="radio" name="gender" value="female" id="gender-female"
                    {% if gender == 'female' %}checked{% endif %}>
                <label for="gender-female" class="radio-btn">Female</label>

                <input type="radio" name="gender" value="male" id="gender-male"
                    {% if gender == 'male' %}checked{% endif %}>
                <label for="gender-male" class="radio-btn">Male</label>
            </div>
        </div>

        <div class="filter-section">
            <h3>Sort By</h3>
            <div class="filter-row">

                <!-- Discipline sorting -->
                <div class="filter-group">
                    <label>Discipline:</label>
                    <div class="radio-buttons">
                        <!-- Overall -->
                        <input type="radio" name="disc" value="overall" id="disc-overall"
                            {% if disc == "overall" %}checked{% endif %}>
                        <label for="disc-overall" class="radio-btn">Overall</label>
                        <!-- Swim -->
                        <input type="radio" name="disc" value="swim" id="disc-swim"
                            {% if disc == "swim" %}checked{% endif %}>
                        <label for="disc-swim" class="radio-btn">Swim</label>
                        <!-- Bike -->
                        <input type="radio" name="disc" value="bike" id="disc-bike"
                            {% if disc == "bike" %}checked{% endif %}>
                        <label for="disc-bike" class="radio-btn">Bike</label>
                        <!-- Run -->
                        <input type="radio" name="disc" value="run" id="disc-run"
                            {% if disc == "run" %}checked{% endif %}>
                        <label for="disc-run" class="radio-btn">Run</label>
                        <!-- Transition -->
                        <input type="radio" name="disc" value="transition" id="disc-transition"
                            {% if disc == "transition" %}checked{% endif %}>
                        <label for="disc-transition" class="radio-btn">Transition</label>
                    </div>
                </div>
                
                <!-- Ordering: top vs hot -->
                <div class="filter-group">
                    <label>Order:</label>
                    <div class="radio-buttons">
                        <input type="radio" name="order" value="top" id="order-top"
                            {% if order == 'top' %}checked{% endif %}>
                        <label for="order-top" class="radio-btn">Top</label>

                        <input type="radio" name="order" value="hot" id="order-hot"
                            {% if order == 'hot' %}checked{% endif %}>
                        <label for="order-hot" class="radio-btn">Hot</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h3>Filter By</h3>
            <div class="filter-row">

                <div class="filter-group">
                    <label for="country">Country:</label>
                    <select name="country" id="country">
                        <!-- Default country value is blank -->
                        <option value="all" {% if country == "all" %}selected{% endif %}>All Countries</option> 
                        
                        <!-- Add all countries from latest country list-->
                        {% for c in all_countries %}
                            <option value="{{ c }}" {% if country == c %}selected{% endif %}>{{ c }}</option>                      
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="yob_start">Birth Year From:</label>
                    <input type="number" name="yob_start" id="yob_start" 
                        min="1950" max="2010" value="{{ yob_start }}" step="1">
                </div>

                <div class="filter-group">
                    <label for="yob_end">Birth Year To:</label>
                    <input type="number" name="yob_end" id="yob_end" 
                        min="1950" max="2010" value="{{ yob_end }}" step="1">
                </div>

                <div class="filter-group">
                    <label for="active_only">
                        <input type="checkbox" name="active_only" id="active_only" value="true"
                            {% if active_only %}checked{% endif %}>
                        Active Only
                    </label>
                </div>
            </div>
        </div>

        <div class="search-buttons">
            <a href="/leaderboard" class="btn">Reset Filters</a>
            <button type="submit" class="btn">Search</button>
        </div>
    </form>
</div>

<div class="results-summary">
    <p>Showing <strong>{{ athletes|length }}</strong> athletes</p>
</div>

<div class="leaderboard-grid">
    {% for athlete in athletes %}
    <div class="athlete-card {{ 'rank-' ~ athlete.rank if athlete.rank <= 3 else '' }}">
        <div class="rank-badge {{ 'rank-' ~ athlete.rank ~ '-text' if athlete.rank <= 3 else '' }}">#{{athlete.rank}}</div>
        <div class="athlete-card-content">
            <div class="athlete-main-info">
                <img src="{{ 'https://static.protridata.com/athlete_imgs/64/' ~ athlete.athlete_id ~ '.webp' if athlete.profile_img_exists else 'https://static.protridata.com/imgs/default_user.jpg' }}" 
                     alt="{{ athlete.name }}" 
                     loading="lazy"
                     class="athlete-profile-img">
                
                <div class="athlete-details">
                    <h2 class="athlete-name">{{ athlete.name }} {{ athlete.country_emoji }}</h2>
                    <div class="athlete-meta">
                        <span class="meta-item">
                            {{ athlete.country_full }}
                        </span>
                        {% if athlete.year_of_birth > 0 %}
                        <span class="meta-item">
                            <strong>YOB:</strong> {{ athlete.year_of_birth }}
                        </span>
                        {% endif %}
                        <span class="meta-item">
                            <strong>Races:</strong> {{ athlete.race_starts }}
                        </span>
                        <span class="meta-item">
                            <strong>Wins:</strong> {{ athlete.win_count }}
                        </span>
                    </div>
                </div>
            </div>

            {% if order == "top" %}
            <!-- Top ordering, display all time ratings -->
            <div class="athlete-ratings">
                <div class="rating-item">
                    <span class="rating-label">Overall</span>
                    <span class="rating-value {% if disc == 'overall' %}rating-highlight{% endif %}">
                        {{ athlete.overall_rating }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Swim</span>
                    <span class="rating-value {% if disc == 'swim' %}rating-highlight{% endif %}">
                        {{ athlete.swim_rating }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Bike</span>
                    <span class="rating-value {% if disc == 'bike' %}rating-highlight{% endif %}">
                        {{ athlete.bike_rating }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Run</span>
                    <span class="rating-value {% if disc == 'run' %}rating-highlight{% endif %}">
                        {{ athlete.run_rating }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Transition</span>
                    <span class="rating-value {% if disc == 'transition' %}rating-highlight{% endif %}">
                        {{ athlete.transition_rating }}
                    </span>
                </div>
            </div>

            {% elif order == "hot" %}
            <!-- Hot ordering, display rating changes with formatted strings and set css classes -->
            <div class="athlete-ratings">
                <div class="rating-item">
                    <span class="rating-label">Overall</span>
                    <span class="rating-value {{ athlete.overall_change.css_class }} {{ 'rating-highlight' if disc == 'overall' }}">
                        {{ athlete.overall_change.formatted_str }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Swim</span>
                    <span class="rating-value {{ athlete.swim_change.css_class }} {{ 'rating-highlight' if disc == 'swim' }}">
                        {{ athlete.swim_change.formatted_str }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Bike</span>
                    <span class="rating-value {{ athlete.bike_change.css_class }} {{ 'rating-highlight' if disc == 'bike' }}">
                        {{ athlete.bike_change.formatted_str }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Run</span>
                    <span class="rating-value {{ athlete.run_change.css_class }} {{ 'rating-highlight' if disc == 'run' }}">
                        {{ athlete.run_change.formatted_str }}
                    </span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Transition</span>
                    <span class="rating-value {{ athlete.transition_change.css_class }} {{ 'rating-highlight' if disc == 'transition' }}">
                        {{ athlete.transition_change.formatted_str }}
                    </span>
                </div>
            </div>
            {% endif %}
        </div>

        <a href="/athlete/{{ athlete.athlete_id }}" class="athlete-card-link">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </a>
    </div>
    {% endfor %}
</div>

<!-- Button to load next athletes, only show if there are more athletes to load -->
{% if athletes|length == 50 %}
<div class="load-more-container">
    <button id="loadMoreBtn" class="btn">Load More</button>
</div>
{% endif %}

{% if not athletes %}
<div class="no-results">
    <p>No athletes found matching your filters.</p>
    <a href="/leaderboard" class="btn">Reset Filters</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://static.protridata.com/js/leaderboard.js"></script>
{% endblock %}
